# Использование с DI

Ниже пример для **PHP-DI**.

## Пример регистрации

```php
use DI\ContainerBuilder;
use PhpSoftBox\Cache\Cache;
use PhpSoftBox\Cache\Configurator\BuiltInDriverFactory;
use PhpSoftBox\Cache\Configurator\CacheConfig;
use PhpSoftBox\Cache\Configurator\CacheStoreFactory;
use PhpSoftBox\Cache\Configurator\CacheStoreFactoryInterface;
use PhpSoftBox\Cache\Configurator\DriverFactoryInterface;
use PhpSoftBox\Cache\Contracts\CacheServiceInterface;
use Psr\SimpleCache\CacheInterface;

$builder = new ContainerBuilder();

$builder->addDefinitions([
    // 1) список driver factories
    BuiltInDriverFactory::class => DI\create(BuiltInDriverFactory::class),

    // 2) CacheStoreFactoryInterface
    CacheStoreFactoryInterface::class => static function (\Psr\Container\ContainerInterface $c) {
        $stores = [
            'default' => new CacheConfig(driver: 'array', namespace: 'app', defaultTtl: 60),
            'files' => new CacheConfig(
                driver: 'file',
                namespace: 'app',
                options: ['directory' => __DIR__ . '/var/cache'],
            ),
        ];

        /** @var DriverFactoryInterface[] $driverFactories */
        $driverFactories = [
            $c->get(BuiltInDriverFactory::class),
        ];

        return new CacheStoreFactory(
            stores: $stores,
            driverFactories: $driverFactories,
        );
    },

    // 3) Cache
    Cache::class => static function (\Psr\Container\ContainerInterface $c) {
        return new Cache(
            storeFactory: $c->get(CacheStoreFactoryInterface::class),
            defaultStore: 'default',
        );
    },

    // Удобные алиасы для внедрения
    CacheServiceInterface::class => DI\get(Cache::class),
    CacheInterface::class => DI\get(Cache::class),
]);

$container = $builder->build();

/** @var Cache $cache */
$cache = $container->get(Cache::class);

$cache->store()->set('a', 1);

/** @var CacheInterface $cache */
$cache = $container->get(CacheInterface::class);
$cache->get('foo');

/** @var CacheServiceInterface $cacheService */
$cacheService = $container->get(CacheServiceInterface::class);
$cacheService->store('files')->set('a', 1);
```

## Как расширять драйверы

Чтобы добавить новый драйвер (redis/pdo/chain), нужно реализовать `DriverFactoryInterface`
и добавить его в массив `$driverFactories`.

```php
use PhpSoftBox\Cache\Configurator\MemcachedDriverFactory;
use PhpSoftBox\Cache\Configurator\PdoConnectionFactory;
use PhpSoftBox\Cache\Configurator\PdoDriverFactory;
use PhpSoftBox\Cache\Configurator\RedisDriverFactory;
use PhpSoftBox\Cache\Driver\Pdo\PdoConnectionOptions;

// Пример: Redis (ext-redis)
\Redis::class => static function () {
    $redis = new \Redis();
    $redis->connect('redis', 6379);
    $redis->select(0);
    return $redis;
},
RedisDriverFactory::class => DI\create(RedisDriverFactory::class)
    ->constructor(DI\get(\Redis::class)),

// Пример: Memcached (ext-memcached)
\Memcached::class => static function () {
    $m = new \Memcached();
    $m->addServer('memcache', 11211);
    return $m;
},
MemcachedDriverFactory::class => DI\create(MemcachedDriverFactory::class)
    ->constructor(DI\get(\Memcached::class)),

// Пример: PDO
PdoConnectionFactory::class => DI\create(PdoConnectionFactory::class),
\PDO::class => static function (\Psr\Container\ContainerInterface $c) {
    /** @var PdoConnectionFactory $f */
    $f = $c->get(PdoConnectionFactory::class);

    return $f->create(new PdoConnectionOptions(
        dsn: 'sqlite::memory:',
        username: null,
        password: null,
        pdoOptions: [\PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION],
    ));
},
PdoDriverFactory::class => DI\create(PdoDriverFactory::class)
    ->constructor(DI\get(\PDO::class)),

// Важно: component Cache не требует ext-redis/ext-memcached как зависимости.
// Если вы хотите использовать эти драйверы — вы ставите расширение/поднимаете сервис на стороне приложения.
```
